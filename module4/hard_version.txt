Assignment 4 hard version